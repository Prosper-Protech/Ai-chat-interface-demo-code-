
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Support – SAMITECH</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<style>
:root{
 --accent:#6366f1;
 --bg-dark:#0b0b10;
 --bg-light:#f5f6fa;
 --panel-dark:rgba(20,20,30,.95);
 --panel-light:#ffffff;
 --text-dark:#ffffff;
 --text-light:#111111;
}
body{margin:0;font-family:Inter,system-ui;background:var(--bg-dark)}
body.light{background:var(--bg-light)}

#aiWidget{position:fixed;right:24px;bottom:24px;z-index:9999}
#aiBubble{width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 10px 30px rgba(99,102,241,.5)}
#aiBubble img{width:42px;height:42px;border-radius:50%}

#aiBox{width:380px;height:540px;border-radius:22px;overflow:hidden;display:none;flex-direction:column;background:var(--panel-dark);color:var(--text-dark);backdrop-filter:blur(30px);box-shadow:0 30px 80px rgba(0,0,0,.7)}
body.light #aiBox{background:var(--panel-light);color:var(--text-light)}

.ai-header{background:url('https://images.unsplash.com/photo-1518770660439-4636190af475') center/cover}
.ai-header-overlay{background:rgba(0,0,0,.6);padding:14px 16px;display:flex;justify-content:space-between;align-items:center}
.ai-header h4{color:#fff;font-weight:600}
.ai-status{font-size:12px;color:#d1d5db}

#messages{flex:1;overflow-y:auto;padding:16px;background:transparent}
.msg{display:flex;gap:10px;margin-bottom:16px;position:relative}
.msg.ai .bubble{background:#fff;color:#111;border-radius:18px 18px 18px 6px;white-space:pre-wrap;word-break:break-word}
.msg.user{justify-content:flex-end}
.msg.user .bubble{background:var(--accent);color:#fff;border-radius:18px 18px 6px 18px;white-space:pre-wrap;word-break:break-word}
.bubble{padding:12px 14px;max-width:75%;font-size:14px;line-height:1.4}
.avatar{width:40px;height:40px;border-radius:50%}

.msg-tools{display:flex;gap:10px;font-size:12px;opacity:.6;margin-top:4px}
.msg-tools span{cursor:pointer}
.msg-tools span:hover{text-decoration:underline}

.ai-input{display:flex;gap:10px;padding:14px;background:rgba(0,0,0,.2)}
.ai-input textarea{flex:1;border-radius:30px;padding:10px 14px;background:rgba(255,255,255,.1);color:inherit;resize:none;border:none;outline:none}
.ai-input button{width:44px;height:44px;border-radius:50%;background:var(--accent);color:#fff;border:none}

.typing{display:flex;gap:6px;padding:10px}
.dot{width:8px;height:8px;border-radius:50%;background:#999;animation:blink 1.4s infinite}
.dot:nth-child(2){animation-delay:.2s}
.dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}

code{background:rgba(0,0,0,.1);padding:2px 4px;border-radius:4px;font-family:monospace;font-size:13px}
ul, ol{margin-left:16px;margin-bottom:4px}
</style>
</head>
<body>

<div id="aiWidget">
 <div id="aiBubble"><img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png"></div>
 <div id="aiBox">
  <div class="ai-header">
   <div class="ai-header-overlay">
    <div>
     <h4>AI Support</h4>
     <div class="ai-status" id="status">Offline</div>
    </div>
    <div style="display:flex;gap:10px">
     <button onclick="toggleTheme()"><i class="fa fa-moon text-white"></i></button>
     <button onclick="toggleChat()"><i class="fa fa-xmark text-white"></i></button>
    </div>
   </div>
  </div>

  <div id="messages"></div>

  <div class="ai-input">
   <textarea id="input" rows="1" placeholder="Ask me anything..."></textarea>
   <button onclick="sendMsg()"><i class="fa fa-paper-plane"></i></button>
  </div>
 </div>
</div>

<script>
let open=false, ws=null, aiMsgEl=null, allowSave=true;

const aiBox=document.getElementById('aiBox'),
      messages=document.getElementById('messages'),
      aiBubble=document.getElementById('aiBubble'),
      input=document.getElementById('input'),
      status=document.getElementById('status');

document.addEventListener('DOMContentLoaded',()=>{ loadChat(); });

aiBubble.onclick=toggleChat;

function toggleChat(){
 open=!open;
 aiBox.style.display=open?'flex':'none';
 if(open) connect();
}

function toggleTheme(){document.body.classList.toggle('light');}

// ===== WebSocket =====
function connect(){
 if(ws && ws.readyState===WebSocket.OPEN) return;
 ws=new WebSocket('wss://backend.buildpicoapps.com/api/chatbot/chat');
 status.textContent='Connecting...';
 ws.onopen=()=>status.textContent='Online';
 ws.onclose=()=>status.textContent='Disconnected';
 ws.onmessage=e=>streamAI(JSON.parse(e.data));
}

function sendMsg(){
 const t=input.value.trim();
 if(!t) return;
 addMsg('user',t);
 input.value='';
 currentAI='';
 showTyping();
 ws.send(JSON.stringify({
  chatId:Date.now(),
  appId:'word-almost',
  systemPrompt:'You are SAMITECH AI Support assistant. Reply in clear human-like format.',
  message:t
 }));
}

function addMsg(type,text){
 const time=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
 const div=document.createElement('div');
 div.className=`msg ${type}`;
 div.innerHTML=`${type==='ai'?`<img class=avatar src=https://cdn-icons-png.flaticon.com/512/4712/4712109.png>`:``}
  <div>
   <div class=bubble>${autoFormat(text)}</div>
   <div class=msg-tools>
    <span onclick=copyMsg(this)>Copy</span>
    <span onclick=editMsg(this)>Edit</span>
    <span onclick=deleteMsg(this)>Delete</span>
    <span>${time}</span>
   </div>
  </div>`;
 messages.appendChild(div);
 scroll(); saveChat();
 return div;
}

// ===== Auto-formatting (lists, bold, code) =====
function autoFormat(text){
 // code formatting: `inline` → <code>inline</code>
 text=text.replace(/`([^`]+)`/g,'<code>$1</code>');
 // bold: **text** → <b>text</b>
 text=text.replace(/\*\*([^*]+)\*\*/g,'<b>$1</b>');
 // unordered list: lines starting with - or * → <ul><li>..</li></ul>
 let lines=text.split('\n');
 let formatted='', inList=false;
 lines.forEach(line=>{
   if(/^(\-|\*)\s+/.test(line)){
     if(!inList){formatted+='<ul>'; inList=true;}
     formatted+=`<li>${line.replace(/^(\-|\*)\s+/,'')}</li>`;
   } else {
     if(inList){formatted+='</ul>'; inList=false;}
     formatted+=line+'<br>';
   }
 });
 if(inList) formatted+='</ul>';
 return formatted;
}

// ===== Streaming AI =====
let currentAI='';
function streamAI(data){
 hideTyping();
 if(!aiMsgEl){
   aiMsgEl=addMsg('ai','');
   currentAI='';
 }
 if(data.message){
   currentAI+=data.message;
   aiMsgEl.querySelector('.bubble').innerHTML=autoFormat(currentAI);
   scroll();
 }
}

// ===== Typing indicator =====
let typingEl=null;
function showTyping(){
 typingEl=document.createElement('div');
 typingEl.className='msg ai';
 typingEl.innerHTML=`<img class=avatar src=https://cdn-icons-png.flaticon.com/512/4712/4712109.png>
 <div class=typing><div class=dot></div><div class=dot></div><div class=dot></div></div>`;
 messages.appendChild(typingEl);
 scroll();
}
function hideTyping(){typingEl?.remove(); typingEl=null;}

function scroll(){messages.scrollTop=messages.scrollHeight}

// ===== Message tools =====
function copyMsg(el){navigator.clipboard.writeText(el.closest('.msg').querySelector('.bubble').innerText);}
function editMsg(el){const b=el.closest('.msg').querySelector('.bubble');const t=prompt('Edit message',b.innerText); if(t) b.innerHTML=autoFormat(t); saveChat();}
function deleteMsg(el){el.closest('.msg').remove(); saveChat();}

// ===== Chat storage =====
function saveChat(){if(!allowSave) return; localStorage.setItem('chatLog',messages.innerHTML);}
function loadChat(){const d=localStorage.getItem('chatLog'); if(d) messages.innerHTML=d;}
</script>

</body>
</html>
